<h2>Materias del plan</h2>

<!-- FILTROS -->
<div class="filters">
  <label><input type="checkbox" [(ngModel)]="filters.available"> Disponibles</label>
  <label><input type="checkbox" [(ngModel)]="filters.approved"> Aprobadas</label>
  <label><input type="checkbox" [(ngModel)]="filters.pending"> Pendiente Final</label>
  <label><input type="checkbox" [(ngModel)]="filters.blocked"> Bloqueadas</label>
</div>

<hr>

<!-- DASHBOARD RESUMEN -->
<div class="summary-wrapper" *ngIf="!loading && totalSubjects > 0">
  <div class="summary-main-card">
    <div class="summary-main-number">{{ completionPct }}%</div>
    <div class="summary-main-label">de la carrera aprobada</div>
    <div class="summary-main-sub">
      {{ totalApproved }} de {{ totalSubjects }} materias
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="label">Total materias</div>
      <div class="value">{{ totalSubjects }}</div>
    </div>
    <div class="summary-card">
      <div class="label">Promedio</div>
      <div class="value">{{ averageGrade > 0 ? (averageGrade | number:'1.2-2') : '-' }}</div>
    </div>

    <div class="summary-card ok">
      <div class="label">Aprobadas</div>
      <div class="value">{{ totalApproved }}</div>
    </div>

    <div class="summary-card pending">
      <div class="label">Pendiente de final</div>
      <div class="value">{{ totalPendingFinal }}</div>
    </div>

    <div class="summary-card available">
      <div class="label">Disponibles para cursar</div>
      <div class="value">{{ totalAvailable }}</div>
    </div>

    <div class="summary-card blocked">
      <div class="label">Bloqueadas por correlativas</div>
      <div class="value">{{ totalBlocked }}</div>
    </div>
  </div>
</div>

<!-- AGRUPADO POR A√ëO -->
<div *ngFor="let year of (grouped | keyvalue)">
  <h3 *ngIf="+year.key > 0">A√±o {{ +year.key }}</h3>

  <div class="year-grid">
    <div *ngFor="let sub of applyFilters(year.value)" 
         class="subject-card"
         [ngClass]="{
           'approved': sub.isApproved,
           'pending': sub.isPending,
           'blocked': sub.isBlocked,
           'available': sub.isAvailable
         }">

      <div class="title">{{ sub.code }} - {{ sub.name }}</div>
      <!-- Campo de nota (solo si est√° aprobada) -->
      <div class="grade-row" *ngIf="sub.isApproved">
        <label>Nota:</label>
        <input
          type="number"
          min="4"
          max="10"
          [(ngModel)]="sub.grade"
          (change)="onGradeChange(sub)"
          class="grade-input"
        />
      </div>


      <!-- Estado -->
      <div class="status">
        <span *ngIf="sub.isApproved">Aprobada ‚úì</span>
        <span *ngIf="sub.isPending">Pendiente de Final ‚è≥</span>
        <span *ngIf="sub.isBlocked">Bloqueada üö´</span>
        <span *ngIf="sub.isAvailable && !sub.isApproved && !sub.isPending">Disponible</span>
      </div>

      <!-- Correlativas -->
      <div *ngIf="sub.isBlocked" class="prereq">
        Requiere:
        <ul>
          <li *ngFor="let p of sub.prerequisites" [class.ok]="p.currentStatus === 'aprobada'">
            {{ p.code }} - {{ p.name }} ({{ p.currentStatus }})
          </li>
        </ul>
      </div>

      <!-- Acciones de estado con iconos -->
      <div class="status-actions" [class.disabled]="sub.isBlocked">
        <!-- Sin cursar -->
        <button
          type="button"
          class="icon-btn"
          [class.active]="sub.status === 'sin_cursar'"
          [disabled]="sub.isBlocked"
          (click)="onStatusClick(sub, 'sin_cursar')"
        >
          <span class="icon">‚óã</span>
          <span class="label">Sin cursar</span>
        </button>

        <!-- Pendiente final -->
        <button
          type="button"
          class="icon-btn"
          [class.active]="sub.status === 'pendiente_final'"
          [disabled]="sub.isBlocked"
          (click)="onStatusClick(sub, 'pendiente_final')"
        >
          <span class="icon">‚è≥</span>
          <span class="label">Final</span>
        </button>

        <!-- Aprobada -->
        <button
          type="button"
          class="icon-btn"
          [class.active]="sub.status === 'aprobada'"
          [disabled]="sub.isBlocked"
          (click)="onStatusClick(sub, 'aprobada')"
        >
          <span class="icon">‚úì</span>
          <span class="label">Aprobada</span>
        </button>
      </div>

    </div>
  </div>

  <hr>
</div>
